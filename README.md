# StepperMRTO
StepperMRTO provides a means to control a linear stepper motor to actuate a model railroad turnout (track switch). In particular the stepper to be controlled will be a "micro" variety that is so small that it can be installed on top of the layout next to the track. Traditionally such actuators have never been stepper motors and are usually installed on the underside of the layout. This code is meant to used along with a "sketch" (program) in an Arduino Nano microcontroller.  

When configured properly the stepper can be connected to the turnout throwbar directly with no omega or Z motion absorbers required. The stepper motor will skip harmlessly if the mechanism encounters an obstruction. It will then recalibrate its position on the next commanded movement. The system also requires no position calibration at installation other than to make sure that the throw is long enough to enable reaching both stock rails and that the torque is strong enough for reliable operation. The code in StepperMRTO.cpp sets up initial conditions that should provide for good performance out of the box.  

Several aspects of the stepper operation can be controlled, namely the speed, length of throw, force (torque) and direction (reversed or not). These are initially set within the Stepper.ino program. Initial values are speed = 1000, throw = 500, force = 1500, reversed = false. As a reference a throw value of 1000 moves the stepper carriage about 7mm.  

The program also includes a menu driven mechanism to change these initial values. This allows the changes to be made without removing the Arduino from its socket and without requiring the use of the Arduino IDE. A portable device such as a laptop, tablet or phone will be plugged into the USB connector to use the menu. The Arduino should be powered externally, not from the USB connector, to use the menu system efficiently. The menu is activated by closing the switch for device 1 while pushing the reset button on the Arduino. Close the switch then briefly push the reset button while maintaining the closed switch. Continue to hold the switch closed for several seconds or until the TX LED flashes once on the Nano. The baud rate is 115,200.  

The code provides for driving four steppers. If commanded simultaneously the program will automatically sequence their movement so that only one runs at a time. Outputs are provided to drive four sets of LEDs, one red and one green for each stepper. These indicate the commanded position. The LEDs will flash while the stepper is moving. The steppers and the LEDs use a multiplexing scheme to limit the number of pins required. The steppers connect the motor A+ and B+ leads in common for all four motors. These are driven from the digital pins 0 and 1. These pins are also used for serial communication and are marked RXD and TXD respectively, i.e. their physical order is reversed. The motor negative side pins are each dedicated to digital pins 2 through 9 in groups of two. See the pinout list in the code. The LED red cathode leads are commoned together and driven from pin A4. The LED green cathode leads are common and are driven from pin A5. Anodes of the red and green LEDs for each motor are connected together and driven from digital pins 10 through 13 for motors 1 through 4 respectively. A resistor with value 270 ohms should be connected to the common anode for each LED pair.   

The steppers are controllable by local momentary switches which toggle the direction of motion. They could also be controlled remotely using a device such as the LCC based rrCirkits Tower node. Any remotely controlled device that can pulse the switch inputs low will work as well. Pins A0 through A3 control devices 1 through 4 respectively. These pins are shorted to ground to actuate.  

The program does not accomodate position feedback. It only knows that it has commanded the turnout in one direction or the other and it assumes that it reaches the other side. The LED indication will be correct for the commanded position. On startup the program does not know the position of the turnout. It will flash the LEDs to indicate this condition. On first command it will move the turnout in a certain, configurable direction. It may already physically be in the commanded position and in that case it will run into the closure rail and the motor will 'slip' until movement is complete. At that point it will be in a known position and will set the LED to the correct non-flashing color.  

StepperMRTO.cpp and StepperMRTO.h should be placed in the libraries folder in the Arduino file structure. Stepper.ino should be placed in a folder of the same name placed at the top level of the Arduino file structure. It can then be accessed from the Arduino IDE.  

An attempt was made to use an external motor driver board. The intent was to increase torque slightly if a weak motor was encountered. This has been only partially successful. Testing indicated that the motor became unstable and jittered rather than moving smoothly. This occurred outside of a narrow band of _torqueInterval which seemed to be centered around 1000 microseconds. Action was smooth and very forceful (likely too forceful) within this band. Several differenct supply voltages to the motor driver were tested ranging from 3 to 7.5 volts. The voltage changed the torque but had not effect on the jitter. Two new techniques for applying current during the step period were tested. One used the normal _torqueInterval as an initial step followed by narrow pulses for the remainder of the step interval. The other used a series of narrow pulses of constant width throughout the step interval. Neither was observed to have any effect on the problem. The trial code was left in StepperMRTO.cpp and .h but commented out.  

When using an external motor driver board, the multiplexing scheme for the motor windings cannot be used. When multiplexed, only 10 pins are required for the four motors rather than 16. If not multiplexed, 4 pins are required for each motor. The end result is that only 3 motors can be attached if using the driver board because we are using all available pins on the Nano. The code in Stepper.ino has been changed to account for this. If 'BOOSTED' is defined the code will compile to provide for the restricted configuration. The pinout is significantly changed in this configuration.
